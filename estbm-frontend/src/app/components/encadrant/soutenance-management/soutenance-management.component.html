<app-navbar></app-navbar>

<div class="soutenance-layout">
  <div class="soutenance-container">
    <!-- Header -->
    <div class="soutenance-header">
      <div class="header-content">
        <div class="header-text">
          <h1>
            <i class="bi bi-calendar-check me-3"></i>
            Mes Planifications de Soutenance
          </h1>
          <p>Gérez vos planifications et créneaux de soutenance</p>
        </div>
        <div class="header-actions">
          <a routerLink="/encadrant/dashboard" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left me-2"></i>
            Retour au tableau de bord
          </a>
        </div>
      </div>
    </div>

    <!-- Vue liste des planifications -->
    <div *ngIf="!selectedPlanification" class="planifications-view">
      <!-- Filtres -->
      <div class="filters-section">
        <div class="filters-card">
          <div class="filters-header">
            <h3>
              <i class="bi bi-funnel me-2"></i>
              Filtres
            </h3>
          </div>
          <div class="filters-body">
            <div class="filter-group">
              <label class="filter-label">
                <i class="bi bi-calendar-date me-2"></i>
                Filtrer par date
              </label>
              <input 
                type="date" 
                class="filter-input"
                [(ngModel)]="dateFilter">
            </div>
            
            <div class="filter-stats">
              <span class="stats-text">
                {{ getFilteredPlanifications().length }} planification(s) trouvée(s)
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Statistiques rapides -->
      <div class="stats-section">
        <div class="stats-grid">
          <div class="stat-card stat-primary">
            <div class="stat-icon">
              <i class="bi bi-calendar-event"></i>
            </div>
            <div class="stat-content">
              <div class="stat-value">{{ planifications.length }}</div>
              <div class="stat-label">Total planifications</div>
            </div>
          </div>

          <div class="stat-card stat-success">
            <div class="stat-icon">
              <i class="bi bi-calendar-check"></i>
            </div>
            <div class="stat-content">
              <div class="stat-value">{{ getUpcomingPlanifications().length }}</div>
              <div class="stat-label">À venir</div>
            </div>
          </div>

          <div class="stat-card stat-secondary">
            <div class="stat-icon">
              <i class="bi bi-calendar-x"></i>
            </div>
            <div class="stat-content">
              <div class="stat-value">{{ getPastPlanifications().length }}</div>
              <div class="stat-label">Passées</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Liste des planifications -->
      <div class="planifications-section">
        <div class="section-header">
          <h2>
            <i class="bi bi-list-ul me-2"></i>
            Vos Planifications
          </h2>
        </div>

        <!-- Loading state -->
        <div *ngIf="loading" class="loading-state">
          <app-loading size="lg" message="Chargement de vos planifications..."></app-loading>
        </div>

        <!-- Empty state -->
        <div *ngIf="!loading && planifications.length === 0" class="empty-state">
          <div class="empty-icon">
            <i class="bi bi-calendar-x"></i>
          </div>
          <h4>Aucune planification</h4>
          <p>Vous n'avez pas encore de planifications de soutenance assignées</p>
        </div>

        <!-- Liste -->
        <div *ngIf="!loading && planifications.length > 0" class="planifications-list">
          <div *ngFor="let planif of getFilteredPlanifications(); let i = index" 
               class="planification-item"
               [style.animation-delay]="i * 100 + 'ms'">
            
            <div class="planif-header">
              <div class="planif-date">
                <div class="date-circle">
                  <span class="day">{{ planif.dateSoutenance | date:'dd' }}</span>
                  <span class="month">{{ planif.dateSoutenance | date:'MMM' }}</span>
                </div>
                <div class="date-info">
                  <h4>{{ formatDate(planif.dateSoutenance) }}</h4>
                  <p>Planification de soutenance</p>
                </div>
              </div>
              
              <div class="planif-actions">
                <button class="btn btn-primary" 
                        (click)="viewPlanificationDetails(planif)">
                  <i class="bi bi-eye me-2"></i>
                  Voir les créneaux
                </button>
                <button class="btn btn-outline-secondary" 
                        (click)="exportPlanificationToPDF(planif)"
                        title="Exporter en PDF">
                  <i class="bi bi-file-earmark-pdf"></i>
                </button>
                <button class="btn btn-outline-info" 
                        (click)="sendNotificationToStudents(planif)"
                        title="Notifier les étudiants">
                  <i class="bi bi-envelope"></i>
                </button>
              </div>
            </div>
            
            <div class="planif-details">
              <div class="detail-item">
                <i class="bi bi-building"></i>
                <span>{{ planif.departement.nom }}</span>
              </div>
              <div class="detail-item">
                <i class="bi bi-people"></i>
                <span>{{ planif.classeGroupe.nom }}</span>
              </div>
              <div class="detail-item">
                <i class="bi bi-calendar-range"></i>
                <span>{{ planif.anneeScolaire.libelle }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Vue détails d'une planification -->
    <div *ngIf="selectedPlanification" class="details-view">
      <!-- Header des détails -->
      <div class="details-header">
        <div class="header-content">
          <div class="header-text">
            <h2>
              <i class="bi bi-clock me-3"></i>
              Créneaux de Soutenance
            </h2>
            <p>{{ formatDate(selectedPlanification.dateSoutenance) }} - {{ selectedPlanification.departement.nom }}</p>
          </div>
          <div class="header-actions">
            <button class="btn btn-outline-secondary" (click)="backToPlanifications()">
              <i class="bi bi-arrow-left me-2"></i>
              Retour aux planifications
            </button>
          </div>
        </div>
      </div>

      <!-- Statistiques des créneaux -->
      <div class="slots-stats">
        <div class="stats-grid">
          <div class="stat-card stat-info">
            <div class="stat-icon">
              <i class="bi bi-clock"></i>
            </div>
            <div class="stat-content">
              <div class="stat-value">{{ getTotalSlots() }}</div>
              <div class="stat-label">Total créneaux</div>
            </div>
          </div>

          <div class="stat-card stat-success">
            <div class="stat-icon">
              <i class="bi bi-check-circle"></i>
            </div>
            <div class="stat-content">
              <div class="stat-value">{{ getOccupiedSlots() }}</div>
              <div class="stat-label">Créneaux occupés</div>
            </div>
          </div>

          <div class="stat-card stat-warning">
            <div class="stat-icon">
              <i class="bi bi-circle"></i>
            </div>
            <div class="stat-content">
              <div class="stat-value">{{ getAvailableSlots() }}</div>
              <div class="stat-label">Créneaux libres</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Liste des créneaux -->
      <div class="slots-section">
        <!-- Loading state -->
        <div *ngIf="loadingDetails" class="loading-state">
          <app-loading size="md" message="Chargement des créneaux..."></app-loading>
        </div>

        <!-- Empty state -->
        <div *ngIf="!loadingDetails && planificationDetails.length === 0" class="empty-state">
          <div class="empty-icon">
            <i class="bi bi-clock"></i>
          </div>
          <h4>Aucun créneau</h4>
          <p>Cette planification ne contient pas encore de créneaux</p>
        </div>

        <!-- Liste des créneaux -->
        <div *ngIf="!loadingDetails && planificationDetails.length > 0" class="slots-list">
          <div *ngFor="let detail of planificationDetails; let i = index" 
               class="slot-item"
               [ngClass]="getSlotStatusClass(detail)"
               [style.animation-delay]="i * 50 + 'ms'">
            
            <div class="slot-time">
              <div class="time-badge">
                <i class="bi bi-clock"></i>
                <span>{{ formatTime(detail.heureDebut) }} - {{ formatTime(detail.heureFin) }}</span>
              </div>
              <div class="slot-status">
                <span class="status-badge" [ngClass]="getSlotStatusClass(detail)">
                  <i class="bi" [ngClass]="isSlotOccupied(detail) ? 'bi-check-circle' : 'bi-circle'"></i>
                  {{ getSlotStatusText(detail) }}
                </span>
              </div>
            </div>
            
            <div class="slot-content">
              <h5>{{ detail.sujet }}</h5>
              <div *ngIf="isSlotOccupied(detail)" class="student-info">
                <i class="bi bi-person"></i>
                <span>{{ detail.etudiant.prenom }} {{ detail.etudiant.nom }}</span>
              </div>
              <div *ngIf="!isSlotOccupied(detail)" class="slot-available-text">
                <i class="bi bi-circle"></i>
                <span>Créneau disponible</span>
              </div>
            </div>
            
            <div class="slot-actions">
              <button class="btn btn-sm btn-outline-primary" title="Modifier">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger" title="Supprimer">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>